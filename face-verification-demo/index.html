<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Verification Demo - StreamFlow</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container { text-align: center; padding: 2rem; max-width: 500px; }
        .card {
            background: rgba(30, 30, 50, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .title {
            font-size: 1.5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 2rem;
        }
        .video-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            overflow: hidden;
            background: #1e1e32;
        }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .face-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .face-oval {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 230px;
            border: 3px dashed rgba(102, 126, 234, 0.6);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .face-oval.detected { border-color: #22c55e; border-style: solid; box-shadow: 0 0 30px rgba(34, 197, 94, 0.3); }
        .face-oval.smile { border-color: #f59e0b; }
        .scanning-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(102, 126, 234, 0.03) 2px, rgba(102, 126, 234, 0.03) 4px);
            animation: scan 2s linear infinite;
        }
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .instruction { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; min-height: 2rem; }
        .status { font-size: 0.8rem; color: #94a3b8; margin-bottom: 1.5rem; }
        .progress-container { background: rgba(255, 255, 255, 0.1); border-radius: 999px; height: 8px; overflow: hidden; margin-bottom: 1.5rem; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 999px; transition: width 0.5s ease; width: 0%; }
        .steps { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1.5rem; }
        .step { width: 10px; height: 10px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .step.active { background: #667eea; box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
        .step.complete { background: #22c55e; }
        .btn {
            padding: 1rem 2rem; border: none; border-radius: 12px; font-size: 0.9rem;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s ease; margin: 0.5rem;
        }
        .btn-success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .emoji { font-size: 3rem; margin-bottom: 1rem; }
        .hidden { display: none; }
        .success-screen, .rejected-screen { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .arrow-indicator { position: absolute; font-size: 2rem; color: #667eea; left: 50%; transform: translateX(-50%); }
        .arrow-up { top: 10px; animation: bounce-up 1s infinite; }
        .arrow-down { bottom: 10px; animation: bounce-down 1s infinite; }
        @keyframes bounce-up { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-10px); } }
        @keyframes bounce-down { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(10px); } }
        .age-warning { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800; font-size: 1.1rem; margin: 1rem 0; }
        .intro-text { color: #94a3b8; font-size: 0.85rem; line-height: 1.7; margin-bottom: 1rem; }
        .privacy-note { color: #64748b; font-size: 0.75rem; line-height: 1.5; margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px; }
        .countdown { font-size: 6rem; font-weight: 900; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: pulse-scale 1s ease-in-out; }
        @keyframes pulse-scale { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .countdown-text { color: #64748b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.2em; margin-top: 1rem; }
        .step-confirmed { color: #22c55e; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600; }
        .radio-link { display: inline-block; margin-top: 1rem; color: #667eea; text-decoration: none; font-size: 0.9rem; }
        .radio-link:hover { text-decoration: underline; }
        .detection-info { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .detection-item { background: rgba(0, 0, 0, 0.2); padding: 0.75rem; border-radius: 8px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .detection-item .label { color: #64748b; margin-bottom: 0.25rem; }
        .detection-item .value { font-weight: 700; color: #22c55e; }
        .detection-item .value.warning { color: #f59e0b; }
        .detection-item .value.error { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Intro Screen -->
        <div id="introScreen" class="card">
            <div class="emoji">üîê</div>
            <h1 class="title">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</h1>
            <p class="subtitle">Identity Verification</p>
            <p class="intro-text">–ü—Ä–∏–≤–µ—Ç! –°–µ–π—á–∞—Å —è —Ç–µ–±—è –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä—É—é –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Ç–≤–æ–µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞.</p>
            <p class="privacy-note">üîí –ú—ã –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º —Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ. –ü–æ—Å–ª–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤—Å—ë –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω–æ.</p>
            <p class="intro-text">–ú–Ω–µ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å, —á—Ç–æ —Ç—ã —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ —Ä–æ–±–æ—Ç –∏–ª–∏ —Ä–µ–±—ë–Ω–æ–∫.</p>
            <p class="age-warning">–î–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏!</p>
            <p class="intro-text" style="margin-bottom: 1.5rem;">–¢—ã —Å–æ–≥–ª–∞—Å–µ–Ω?</p>
            <button class="btn btn-success" onclick="agreeAndStart()">‚úì –°–æ–≥–ª–∞—Å–µ–Ω!</button>
            <br><a href="#" class="radio-link" onclick="listenToRadio()">üéµ –ù–µ—Ç, —Å–ª—É—à–∞—Ç—å —Ä–∞–¥–∏–æ</a>
        </div>

        <!-- Countdown Screen -->
        <div id="countdownScreen" class="card hidden">
            <div class="emoji">üì∑</div>
            <h1 class="title">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h1>
            <p class="subtitle">Preparing Camera</p>
            <div id="countdownNumber" class="countdown">3</div>
            <p class="countdown-text">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑...</p>
        </div>

        <!-- Verification Screen -->
        <div id="verificationScreen" class="card hidden">
            <h1 class="title">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
            <p class="subtitle">Face Recognition</p>
            <div class="video-container">
                <video id="video" autoplay muted playsinline></video>
                <div class="face-overlay">
                    <div class="scanning-lines"></div>
                    <div id="faceOval" class="face-oval"></div>
                    <div id="arrowUp" class="arrow-indicator arrow-up hidden">üëÜ</div>
                    <div id="arrowDown" class="arrow-indicator arrow-down hidden">üëá</div>
                </div>
            </div>
            <p id="instruction" class="instruction">–û–∂–∏–¥–∞–Ω–∏–µ...</p>
            <p id="status" class="status">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
            <p id="stepConfirmed" class="step-confirmed hidden">‚úì –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ!</p>
            <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
            <div class="steps">
                <div id="step1" class="step"></div>
                <div id="step2" class="step"></div>
                <div id="step3" class="step"></div>
                <div id="step4" class="step"></div>
            </div>
            <div class="detection-info">
                <div class="detection-item"><div class="label">–õ–∏—Ü–æ</div><div id="faceStatus" class="value error">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>
                <div class="detection-item"><div class="label">–£–ª—ã–±–∫–∞</div><div id="smileStatus" class="value error">‚Äî</div></div>
                <div class="detection-item"><div class="label">–ù–∞–∫–ª–æ–Ω</div><div id="tiltStatus" class="value">–¶–µ–Ω—Ç—Ä</div></div>
                <div class="detection-item"><div class="label">–°—Ç–∞—Ç—É—Å</div><div id="ageStatus" class="value warning">...</div></div>
            </div>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="card hidden success-screen">
            <div class="emoji">‚úÖ</div>
            <h1 class="title" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; background-clip: text;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <p class="subtitle">Verification Complete</p>
            <p style="color: #94a3b8; font-size: 0.95rem; margin-bottom: 1rem;">–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —Ç—ã –Ω–∞—à —É—á–∞—Å—Ç–Ω–∏–∫. üéâ</p>
            <p style="color: #64748b; font-size: 0.8rem; margin-bottom: 2rem;">–£ —Ç–µ–±—è –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É.</p>
            <button class="btn btn-success" onclick="resetDemo()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–µ–º–æ</button>
        </div>

        <!-- Rejected Screen -->
        <div id="rejectedScreen" class="card hidden rejected-screen">
            <div class="emoji">‚õî</div>
            <h1 class="title" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); -webkit-background-clip: text; background-clip: text;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h1>
            <p class="subtitle">Access Denied</p>
            <p style="color: #94a3b8; font-size: 0.95rem; margin-bottom: 1rem;">–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ –≤—ã –≤—ã–∑—ã–≤–∞–µ—Ç–µ –Ω–µ–¥–æ–≤–µ—Ä–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É.</p>
            <p style="color: #ef4444; font-size: 0.9rem; margin-bottom: 1.5rem; font-weight: 600;">–ß–∞—Ç –¥–ª—è –≤–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>
            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 2rem;">üéµ –í—ã –º–æ–∂–µ—Ç–µ —Å–ª—É—à–∞—Ç—å –Ω–∞—à–µ —Ä–∞–¥–∏–æ!</p>
            <button class="btn btn-primary" onclick="listenToRadio()">üéµ –°–ª—É—à–∞—Ç—å —Ä–∞–¥–∏–æ</button>
            <br><br><button class="btn btn-danger" onclick="resetDemo()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <script>
        let video;
        let isRunning = false;
        let currentStep = 0;
        let smileDetected = false;
        let headDownDetected = false;
        let headUpDetected = false;
        let faceDetectedCount = 0;
        let stepHoldCounter = 0;
        let isWaitingForNextStep = false;
        let ageCheckPassed = true;
        let suspiciousCount = 0;
        let lastSpokenTime = 0;
        
        // SIMPLIFIED: Lower thresholds, faster detection
        const HOLD_REQUIRED = 10; // Very quick hold
        const FACE_DETECT_THRESHOLD = 20; // Just 20 frames = ~0.7 seconds

        const STEPS = [
            { instruction: '–ü–æ–º–µ—Å—Ç–∏—Ç–µ –ª–∏—Ü–æ –≤ –æ–≤–∞–ª', status: '–°–º–æ—Ç—Ä–∏—Ç–µ –≤ –∫–∞–º–µ—Ä—É', voice: '–ü–æ–º–µ—Å—Ç–∏—Ç–µ –ª–∏—Ü–æ –≤ –æ–≤–∞–ª' },
            { instruction: 'üëá –û–ø—É—Å—Ç–∏—Ç–µ –≥–æ–ª–æ–≤—É –≤–Ω–∏–∑', status: '–ù–∞–∫–ª–æ–Ω–∏—Ç–µ –≤–Ω–∏–∑', voice: '–û–ø—É—Å—Ç–∏—Ç–µ –≥–æ–ª–æ–≤—É —Å–ª–µ–≥–∫–∞ –≤–Ω–∏–∑' },
            { instruction: 'üëÜ –ü–æ–¥–Ω–∏–º–∏—Ç–µ –≥–æ–ª–æ–≤—É –≤–≤–µ—Ä—Ö', status: '–ü–æ–¥–Ω–∏–º–∏—Ç–µ –≤–≤–µ—Ä—Ö', voice: '–¢–µ–ø–µ—Ä—å –ø–æ–¥–Ω–∏–º–∏—Ç–µ –≥–æ–ª–æ–≤—É –≤–≤–µ—Ä—Ö' },
            { instruction: '–£–ª—ã–±–Ω–∏—Ç–µ—Å—å üòä', status: '–ü–æ–∫–∞–∂–∏—Ç–µ —É–ª—ã–±–∫—É', voice: '–ò —É–ª—ã–±–Ω–∏—Ç–µ—Å—å!' }
        ];

        function speak(text) {
            // Prevent speaking too often
            const now = Date.now();
            if (now - lastSpokenTime < 3000) return;
            lastSpokenTime = now;
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 0.9;
                const voices = window.speechSynthesis.getVoices();
                const russianVoice = voices.find(v => v.lang.startsWith('ru'));
                if (russianVoice) utterance.voice = russianVoice;
                window.speechSynthesis.speak(utterance);
            }
        }

        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => console.log('Voices loaded');
        }

        function listenToRadio() {
            speak('–•–æ—Ä–æ—à–æ, –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è!');
            alert('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–∞–¥–∏–æ...');
        }

        function agreeAndStart() {
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('countdownScreen').classList.remove('hidden');
            speak('–û—Ç–ª–∏—á–Ω–æ! –ù–∞—á–∏–Ω–∞–µ–º.');
            
            setTimeout(() => {
                let count = 3;
                const countdownEl = document.getElementById('countdownNumber');
                const countdownInterval = setInterval(() => {
                    if (count > 0) {
                        countdownEl.textContent = count;
                        countdownEl.style.animation = 'none';
                        countdownEl.offsetHeight;
                        countdownEl.style.animation = 'pulse-scale 1s ease-in-out';
                        speak(String(count));
                        count--;
                    } else {
                        clearInterval(countdownInterval);
                        speak('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!');
                        setTimeout(startCamera, 500);
                    }
                }, 1000);
            }, 1000);
        }

        async function startCamera() {
            document.getElementById('countdownScreen').classList.add('hidden');
            document.getElementById('verificationScreen').classList.remove('hidden');
            
            try {
                updateInstruction('–ó–∞–≥—Ä—É–∑–∫–∞...', '–ü–æ–¥–æ–∂–¥–∏—Ç–µ');
                
                // Load only essential models - faster loading
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'),
                    faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/')
                ]);

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: 320, height: 240 } // Lower resolution = faster
                });
                
                video = document.getElementById('video');
                video.srcObject = stream;
                await new Promise(resolve => { video.onloadedmetadata = resolve; });

                isRunning = true;
                currentStep = 0;
                faceDetectedCount = 0;
                updateStep(0);
                
                setTimeout(() => {
                    speak(STEPS[0].voice);
                }, 300);
                
                detectFace();
                
            } catch (error) {
                console.error('Error:', error);
                updateInstruction('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã', '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø');
                speak('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.');
            }
        }

        async function detectFace() {
            if (!isRunning) return;

            try {
                const detections = await faceapi
                    .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.3 }))
                    .withFaceLandmarks()
                    .withFaceExpressions();

                const faceOval = document.getElementById('faceOval');
                const faceStatusEl = document.getElementById('faceStatus');
                const smileStatusEl = document.getElementById('smileStatus');
                const tiltStatusEl = document.getElementById('tiltStatus');
                const ageStatusEl = document.getElementById('ageStatus');

                if (detections) {
                    faceDetectedCount++;
                    faceOval.classList.add('detected');
                    faceStatusEl.textContent = '–ù–∞–π–¥–µ–Ω–æ ‚úì';
                    faceStatusEl.className = 'value';
                    ageStatusEl.textContent = 'OK';
                    ageStatusEl.className = 'value';

                    const landmarks = detections.landmarks;
                    const nose = landmarks.getNose();
                    const leftEye = landmarks.getLeftEye();
                    const rightEye = landmarks.getRightEye();
                    const jaw = landmarks.getJawOutline();
                    
                    const eyeCenterY = (leftEye[0].y + rightEye[3].y) / 2;
                    const noseY = nose[6].y;
                    const jawY = jaw[8].y;
                    const normalizedTilt = (noseY - eyeCenterY) / (jawY - eyeCenterY);

                    const happiness = detections.expressions.happy;
                    const isSmiling = happiness > 0.4; // Lower threshold

                    smileStatusEl.textContent = isSmiling ? `${Math.round(happiness * 100)}% üòä` : `${Math.round(happiness * 100)}%`;
                    smileStatusEl.className = isSmiling ? 'value' : 'value warning';
                    if (isSmiling) faceOval.classList.add('smile'); else faceOval.classList.remove('smile');

                    // Tilt status - more lenient thresholds
                    if (normalizedTilt > 0.51) tiltStatusEl.textContent = '‚Üì –í–Ω–∏–∑';
                    else if (normalizedTilt < 0.49) tiltStatusEl.textContent = '‚Üë –í–≤–µ—Ä—Ö';
                    else tiltStatusEl.textContent = '–¶–µ–Ω—Ç—Ä';

                    if (!isWaitingForNextStep) {
                        processStep(isSmiling, normalizedTilt);
                    }

                } else {
                    // Don't reset everything on missing face - just decrement slightly
                    if (faceDetectedCount > 0) faceDetectedCount--;
                    faceOval.classList.remove('detected', 'smile');
                    faceStatusEl.textContent = '–ò—â—É...';
                    faceStatusEl.className = 'value warning';
                }
            } catch (e) {
                console.log('Detection error, continuing...');
            }

            requestAnimationFrame(detectFace);
        }

        function showConfirmed() {
            const confirmEl = document.getElementById('stepConfirmed');
            confirmEl.classList.remove('hidden');
            setTimeout(() => { confirmEl.classList.add('hidden'); }, 1200);
        }

        function goToNextStep(nextStepIndex, successMessage) {
            isWaitingForNextStep = true;
            showConfirmed();
            speak(successMessage);
            
            setTimeout(() => {
                completeStep(nextStepIndex - 1);
                currentStep = nextStepIndex;
                stepHoldCounter = 0;
                
                if (nextStepIndex < 4) {
                    updateStep(nextStepIndex);
                    setTimeout(() => {
                        speak(STEPS[nextStepIndex].voice);
                        isWaitingForNextStep = false;
                    }, 400);
                } else {
                    finishVerification();
                }
            }, 1500);
        }

        function processStep(isSmiling, tiltAmount) {
            const arrowUp = document.getElementById('arrowUp');
            const arrowDown = document.getElementById('arrowDown');
            arrowUp.classList.add('hidden');
            arrowDown.classList.add('hidden');

            switch (currentStep) {
                case 0: // Just detect face - simple!
                    if (faceDetectedCount >= FACE_DETECT_THRESHOLD) {
                        goToNextStep(1, '–û—Ç–ª–∏—á–Ω–æ! –õ–∏—Ü–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.');
                    }
                    break;

                case 1: // Head down - lenient threshold
                    arrowDown.classList.remove('hidden');
                    if (tiltAmount > 0.51) {
                        stepHoldCounter++;
                        if (stepHoldCounter >= HOLD_REQUIRED && !headDownDetected) {
                            headDownDetected = true;
                            goToNextStep(2, '–•–æ—Ä–æ—à–æ! –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.');
                        }
                    } else {
                        if (stepHoldCounter > 0) stepHoldCounter--;
                    }
                    break;

                case 2: // Head up - lenient threshold
                    arrowUp.classList.remove('hidden');
                    if (tiltAmount < 0.49) {
                        stepHoldCounter++;
                        if (stepHoldCounter >= HOLD_REQUIRED && !headUpDetected) {
                            headUpDetected = true;
                            goToNextStep(3, '–û—Ç–ª–∏—á–Ω–æ! –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.');
                        }
                    } else {
                        if (stepHoldCounter > 0) stepHoldCounter--;
                    }
                    break;

                case 3: // Smile - lower threshold
                    if (isSmiling) {
                        stepHoldCounter++;
                        if (stepHoldCounter >= HOLD_REQUIRED && !smileDetected) {
                            smileDetected = true;
                            goToNextStep(4, '–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —É–ª—ã–±–∫–∞!');
                        }
                    } else {
                        if (stepHoldCounter > 0) stepHoldCounter--;
                    }
                    break;
            }

            // Update progress
            const progress = ((currentStep / 4) * 100) + (currentStep === 0 ? (faceDetectedCount / FACE_DETECT_THRESHOLD) * 25 : 0);
            document.getElementById('progressBar').style.width = Math.min(progress, 100) + '%';
        }

        function updateStep(stepIndex) {
            const step = STEPS[stepIndex];
            updateInstruction(step.instruction, step.status);
            for (let i = 0; i < 4; i++) {
                const stepEl = document.getElementById(`step${i + 1}`);
                stepEl.classList.remove('active');
                if (i === stepIndex) stepEl.classList.add('active');
            }
        }

        function completeStep(stepIndex) {
            const stepEl = document.getElementById(`step${stepIndex + 1}`);
            stepEl.classList.remove('active');
            stepEl.classList.add('complete');
        }

        function updateInstruction(instruction, status) {
            document.getElementById('instruction').textContent = instruction;
            document.getElementById('status').textContent = status;
        }

        function finishVerification() {
            isRunning = false;
            if (video && video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
            document.getElementById('verificationScreen').classList.add('hidden');
            
            // Always success for now (age detection is problematic)
            speak('–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —Ç—ã –Ω–∞—à —É—á–∞—Å—Ç–Ω–∏–∫. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
            document.getElementById('successScreen').classList.remove('hidden');
        }

        function resetDemo() {
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            currentStep = 0;
            smileDetected = false;
            headDownDetected = false;
            headUpDetected = false;
            faceDetectedCount = 0;
            stepHoldCounter = 0;
            isWaitingForNextStep = false;
            isRunning = false;
            lastSpokenTime = 0;

            if (video && video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());

            document.getElementById('progressBar').style.width = '0%';
            for (let i = 1; i <= 4; i++) document.getElementById(`step${i}`).classList.remove('active', 'complete');

            document.getElementById('successScreen').classList.add('hidden');
            document.getElementById('rejectedScreen').classList.add('hidden');
            document.getElementById('verificationScreen').classList.add('hidden');
            document.getElementById('countdownScreen').classList.add('hidden');
            document.getElementById('introScreen').classList.remove('hidden');
        }

        window.onload = function() {
            setTimeout(() => {
                speak('–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä—É—é —Ç–µ–±—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞. –ú—ã –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–µ–Ω, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –°–æ–≥–ª–∞—Å–µ–Ω.');
            }, 500);
        };
    </script>
</body>
</html>
